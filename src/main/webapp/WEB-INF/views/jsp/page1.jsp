<!doctype html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>巢湖人的比鸡</title>



<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/default.css">
<link rel="stylesheet" type="text/css" href="css/person.css?1">
<link rel="stylesheet" type="text/css" href="css/sandao.css?1">
<link rel="stylesheet" type="text/css" href="css/gameover.css">
<link rel="stylesheet" type="text/css" href="css/ready.css">
<link rel="stylesheet" type="text/css" href="css/cards.css?11">
<link href="css/example.css" rel="stylesheet">



</head>
<body>


<p class="ready ready-pos-0">
	准备
</p>
<p class="ready ready-pos-1">
	准备
</p>
<p class="ready ready-pos-2">
	准备
</p>
<p class="ready ready-pos-3">
	准备
</p>
<p class="ready ready-pos-4">
	准备
</p>

<!--p style="width:50px;height:70px" class="ready person-pos-0">
	准备
</p>
<p style="width:50px;height:70px" class="ready person-pos-1">
	准备
</p>
<p style="width:50px;height:70px" class="ready person-pos-2">
	准备
</p>
<p style="width:50px;height:70px" class="ready person-pos-3">
	准备
</p>
<p style="width:50px;height:70px" class="ready person-pos-4">
	准备
</p-->



<div class="card submitted-three-pokers-0-0-0 submit-cards cards-0"><div class="face face-background"></div></div><div class="card submitted-three-pokers-0-0-1 submit-cards cards-0"><div class="face face-background"></div></div><div class="card submitted-three-pokers-0-0-2 submit-cards cards-0"><div class="face face-background"></div></div><div class="card submitted-three-pokers-0-1-0 submit-cards cards-0"><div class="face face-background"></div></div><div class="card submitted-three-pokers-0-1-1 submit-cards cards-0"><div class="face face-background"></div></div><div class="card submitted-three-pokers-0-1-2 submit-cards cards-0"><div class="face face-background"></div></div><div class="card submitted-three-pokers-0-2-0 submit-cards cards-0"><div class="face face-background"></div></div><div class="card submitted-three-pokers-0-2-1 submit-cards cards-0"><div class="face face-background"></div></div><div class="card submitted-three-pokers-0-2-2 submit-cards cards-0"><div class="face face-background"></div></div>

<div class="card submitted-three-pokers-1-0-0 submit-cards cards-1"><div class="face face-background"></div></div><div class="card submitted-three-pokers-1-0-1 submit-cards cards-1"><div class="face face-background"></div></div><div class="card submitted-three-pokers-1-0-2 submit-cards cards-1"><div class="face face-background"></div></div><div class="card submitted-three-pokers-1-1-0 submit-cards cards-1"><div class="face face-background"></div></div><div class="card submitted-three-pokers-1-1-1 submit-cards cards-1"><div class="face face-background"></div></div><div class="card submitted-three-pokers-1-1-2 submit-cards cards-1"><div class="face face-background"></div></div><div class="card submitted-three-pokers-1-2-0 submit-cards cards-1"><div class="face face-background"></div></div><div class="card submitted-three-pokers-1-2-1 submit-cards cards-1"><div class="face face-background"></div></div><div class="card submitted-three-pokers-1-2-2 submit-cards cards-1"><div class="face face-background"></div></div>

<div class="card submitted-three-pokers-2-0-0 submit-cards cards-2"><div class="face face-background"></div></div><div class="card submitted-three-pokers-2-0-1 submit-cards cards-2"><div class="face face-background"></div></div><div class="card submitted-three-pokers-2-0-2 submit-cards cards-2"><div class="face face-background"></div></div><div class="card submitted-three-pokers-2-1-0 submit-cards cards-2"><div class="face face-background"></div></div><div class="card submitted-three-pokers-2-1-1 submit-cards cards-2"><div class="face face-background"></div></div><div class="card submitted-three-pokers-2-1-2 submit-cards cards-2"><div class="face face-background"></div></div><div class="card submitted-three-pokers-2-2-0 submit-cards cards-2"><div class="face face-background"></div></div><div class="card submitted-three-pokers-2-2-1 submit-cards cards-2"><div class="face face-background"></div></div><div class="card submitted-three-pokers-2-2-2 submit-cards cards-2"><div class="face face-background"></div></div>

<div class="card submitted-three-pokers-3-0-0 submit-cards cards-3"><div class="face face-background"></div></div><div class="card submitted-three-pokers-3-0-1 submit-cards cards-3"><div class="face face-background"></div></div><div class="card submitted-three-pokers-3-0-2 submit-cards cards-3"><div class="face face-background"></div></div><div class="card submitted-three-pokers-3-1-0 submit-cards cards-3"><div class="face face-background"></div></div><div class="card submitted-three-pokers-3-1-1 submit-cards cards-3"><div class="face face-background"></div></div><div class="card submitted-three-pokers-3-1-2 submit-cards cards-3"><div class="face face-background"></div></div><div class="card submitted-three-pokers-3-2-0 submit-cards cards-3"><div class="face face-background"></div></div><div class="card submitted-three-pokers-3-2-1 submit-cards cards-3"><div class="face face-background"></div></div><div class="card submitted-three-pokers-3-2-2 submit-cards cards-3"><div class="face face-background"></div></div>

<div class="card submitted-three-pokers-4-0-0 submit-cards cards-4"><div class="face face-background"></div></div><div class="card submitted-three-pokers-4-0-1 submit-cards cards-4"><div class="face face-background"></div></div><div class="card submitted-three-pokers-4-0-2 submit-cards cards-4"><div class="face face-background"></div></div><div class="card submitted-three-pokers-4-1-0 submit-cards cards-4"><div class="face face-background"></div></div><div class="card submitted-three-pokers-4-1-1 submit-cards cards-4"><div class="face face-background"></div></div><div class="card submitted-three-pokers-4-1-2 submit-cards cards-4"><div class="face face-background"></div></div><div class="card submitted-three-pokers-4-2-0 submit-cards cards-4"><div class="face face-background"></div></div><div class="card submitted-three-pokers-4-2-1 submit-cards cards-4"><div class="face face-background"></div></div><div class="card submitted-three-pokers-4-2-2 submit-cards cards-4"><div class="face face-background"></div></div>


<div id="room_id" style="position:absolute;left:0;top:0;color:white"></div>
<div id="numth" style="position:absolute;left:0;top:15px;color:white"></div>

<article class="zzsc-container">

	<div id="container"></div>
	<!--div id="topbar"></div-->
	
</article>



<div id="loadingWrapper" class="sandao">

	<div class="toudao">
		<div class="tou_h"><div class="tou_hp"><p>头</p></div></div>
		<div class="tou_content"><div id="tou_id" class="tou_contentp"></div></div>
	</div>
	<div class="zhongdao">
		<div class="zhong_h"><div class="zhong_hp"><p>中</p></div></div>
		<div class="zhong_content"><div id="zhong_id" class="zhong_contentp"></div></div>
	</div>
	<div class="weidao">
		<div class="wei_h"><div class="wei_hp"><p>尾</p></div></div>
		<div class="wei_content"><div id="wei_id" class="wei_contentp"></div></div>
	</div>
	
	<p class="pity giveup">
		弃牌
	</p>
	
	<p class="pity submit">
		提交
	</p>

	<div id='messages' style="display:none">
	</div>
	
</div>


<div id="gameover" class="sandao">
	
	<p class="pity prepare">
		准备新的一局
	</p>
	<p class="pity over">
		结束
	</p>
</div>

<!--script src="dist/deck.js"></script>
<script src="js/example.js"></script-->

</body>
</html>

<script src="js/jquery.min.js"></script>
<script src="js/deck.js"></script>
<script src="js/bijiDeck.js?1"></script>
<!--script src="js/test.js"></script-->

<script  type="text/javascript">
var localVar = {
	people:[],// person_id:int 0--->离线    1--->在线    2--->已经submit
	global:{},
	mySelf:"${person_id}"
};

var colors = ["<span style='color:red'>♦</span>","♣","<span style='color:red'>♥</span>","♠"];
var pokeStr = ["2","3","4","5","6","7","8","9","10","J","Q","K","A"]


var easing = Deck.easing
var prefix = Deck.prefix

var transform = prefix('transform')
var transition = prefix('transition')
var transitionDelay = prefix('transitionDelay')
var boxShadow = prefix('boxShadow')

var translate = Deck.translate

var $container = document.getElementById('container')
var $topbar = document.getElementById('topbar')

var deck


//var webSocket = new WebSocket('ws://localhost:8080/biji/webSocketServer'); 
var webSocket = new WebSocket('ws://47.95.8.214/biji/webSocketServer'); 

webSocket.onerror = function(event) {  
    alert(event.data);  
};  
//与WebSocket建立连接  
webSocket.onopen = function(event) {  
    document.getElementById('messages').innerHTML = '与服务器端建立连接';  
};  
//处理服务器返回的信息  
webSocket.onmessage = function(event) {  
    document.getElementById('messages').innerHTML += '<br />';
	document.getElementById('messages').innerHTML += '<br />';
    var data = event.data;
	
	var o = JSON.parse(data);
	document.getElementById('messages').innerHTML += handle(o);
};  


var loadingWrapper = document.getElementById("loadingWrapper");







$(function(){
	var res = ajaxGet('get-global-mes');
	if(res.status == 'failed'){
		alert(res.message);
		window.location.href = 'hall';
	}else if(res.status == 'failed-e'){
		alert(res.message);
		window.location.href = 'e';
	}else{
		init(res);
	}
	
})

function init(res){
	var global = res.data;
	var this_person_id = localVar.mySelf;
	localVar.people[this_person_id] = 1;
	deck = bijiDeck(global.people_num,document.body,false);
	deck.mount($container)
	deck.addPerson(this_person_id);
	$("#numth").html((global.number_th+1) + '/' + global.number_of_games)
	$("#room_id").html(global.room_id);
	handle(res);
}

function handle(o){

	var res_error_msg = "res_error_msg";
	var res_global_msg = "res_global_msg";
	var res_user_reconnected = "res_user_reconnected";
	var res_user_prepare = "res_user_prepare";
	var res_new_join = "res_new_join";
	
	
	if(o.type == res_error_msg){
		
		alert(o.message);
		// 提示错误信息
		
	}else if(o.type == res_user_reconnected){
		
		// 提示那个人重新链接了
		alert(o.data + o.message);
		
	}else if(o.type == res_user_prepare){
		
		// 提示哪个人准备好了
		//alert(o.data + o.message);
		handleSubmitPerson(o.data);
	}else if(o.type == res_global_msg){
		
		// 根据global 来看看具体怎么处理
		
		var global = o.data;
		localVar.global = global;
		return handleGlobal(global);
	}
	
}

function sortViewOrderTpukes(i,people_num,this_person_detail,tpokers,point){
	setTimeout(function(){
		i = i-i%people_num;
		for(var m=0;m<3;m++){
			$cardi = myCard(btof(tpokers.pukes[m].id),90);
			$cardi.addClass('three-pokers');
			$cardi.addClass('three-pokers-'+this_person_detail.index+'-'+i/people_num+'-'+m);
			$('body').append($cardi);
		}
		var $pointi = $('<div class="point-'+this_person_detail.index+'-'+i/people_num+'"></div>');
		$pointi.html(point>0?('+'+point):point);
		$pointi.addClass("point");
		$('body').append($pointi);
	},500+500*i);
}


// 使用可变宽度框架
function changeCardCss($card){
	$card.style.width = "42px";
	$card.style.height = "60px";
	$card.style.transform = '';
	$card.style.left = 'unset';
	$card.style.top = 'unset';
	$card.style.marginLeft = '4px';
	$card.style.marginRight = '4px';
	$card.style.display = 'block';
	$card.style.zIndex = '0';
	$card.style.position = 'relative';
	$card.style.float = 'left';
}

$(".toudao").click(function(){
	if(deck.first.length === 0){
		var A = [];
		for(var i=0;i<deck.my_cards.length;i++){
			if(deck.my_cards[i].chosen){
				A.push(deck.my_cards[i].i);
			}
		}
		if(A.length == 3){
		
			for(var i=0;i<deck.my_cards.length;i++){
				
				if(deck.my_cards[i].i == A[0] || deck.my_cards[i].i == A[1] || deck.my_cards[i].i == A[2]){
					deck.my_cards[i].$el.style.display = "none";
					deck.my_cards[i].chosen = false;
					deck.my_cards[i].$el.style.top = parseInt(deck.my_cards[i].$el.style.top.substring(0,deck.my_cards[i].$el.style.top.length-2)) + 10 + 'px';
				}
				
			}
			
			deck.first = A;
			for(var i=0;i<3;i++){
				var card = Deck.Card(A[i],true);
				changeCardCss(card.$el);
				var tou_content = document.getElementById("tou_id");
				tou_content.appendChild(card.$el);
				$('.toudao .topleft').css("top","0");
				$('.toudao .bottomright').css("bottom","0");
			}
		}
	}else{
		for(var i=0;i<deck.my_cards.length;i++){
			if(deck.my_cards[i].i == deck.first[0] || deck.my_cards[i].i == deck.first[1] || deck.my_cards[i].i == deck.first[2]){
				deck.my_cards[i].$el.style.display = "block";
			}
		}
		
		$(".toudao .card").remove();
		
		deck.first = [];
	}
})

$(".zhongdao").click(function(){
	if(deck.second.length === 0){
		var A = [];
		for(var i=0;i<deck.my_cards.length;i++){
			if(deck.my_cards[i].chosen){
				A.push(deck.my_cards[i].i);
			}
		}
		if(A.length == 3){
		
			for(var i=0;i<deck.my_cards.length;i++){
				
				if(deck.my_cards[i].i == A[0] || deck.my_cards[i].i == A[1] || deck.my_cards[i].i == A[2]){
					deck.my_cards[i].$el.style.display = "none";
					deck.my_cards[i].chosen = false;
					deck.my_cards[i].$el.style.top = parseInt(deck.my_cards[i].$el.style.top.substring(0,deck.my_cards[i].$el.style.top.length-2)) + 10 + 'px';
				}
				
			}
			
			deck.second = A;
			for(var i=0;i<3;i++){
				var card = Deck.Card(A[i],true);
				changeCardCss(card.$el);
				var tou_content = document.getElementById("zhong_id");
				tou_content.appendChild(card.$el);
				
				$('.zhongdao .topleft').css("top","0");
				$('.zhongdao .bottomright').css("bottom","0");
			}
		}
	}else{
		for(var i=0;i<deck.my_cards.length;i++){
			if(deck.my_cards[i].i == deck.second[0] || deck.my_cards[i].i == deck.second[1] || deck.my_cards[i].i == deck.second[2]){
				deck.my_cards[i].$el.style.display = "block";
			}
		}
		
		$(".zhongdao .card").remove();
		
		deck.second = [];
	}
})

$(".weidao").click(function(){
	if(deck.third.length === 0){
		var A = [];
		for(var i=0;i<deck.my_cards.length;i++){
			if(deck.my_cards[i].chosen){
				A.push(deck.my_cards[i].i);
			}
		}
		if(A.length == 3){
		
			for(var i=0;i<deck.my_cards.length;i++){
				
				if(deck.my_cards[i].i == A[0] || deck.my_cards[i].i == A[1] || deck.my_cards[i].i == A[2]){
					deck.my_cards[i].$el.style.display = "none";
					deck.my_cards[i].chosen = false;
					deck.my_cards[i].$el.style.top = parseInt(deck.my_cards[i].$el.style.top.substring(0,deck.my_cards[i].$el.style.top.length-2)) + 10 + 'px';
				}
				
			}
			
			deck.third = A;
			for(var i=0;i<3;i++){
				var card = Deck.Card(A[i],true);
				changeCardCss(card.$el);
				var tou_content = document.getElementById("wei_id");
				tou_content.appendChild(card.$el);
				$('.weidao .topleft').css("top","0");
				$('.weidao .bottomright').css("bottom","0");
			}
		}
	}else{
		for(var i=0;i<deck.my_cards.length;i++){
			if(deck.my_cards[i].i == deck.third[0] || deck.my_cards[i].i == deck.third[1] || deck.my_cards[i].i == deck.third[2]){
				deck.my_cards[i].$el.style.display = "block";
			}
		}
		
		$(".weidao .card").remove();
		
		deck.third = [];
	}
})

$(".submit").click(function(){
	var sub = [];
	removePrepare();
	if(deck.first.length != 3 || deck.second.length != 3 || deck.third.length != 3){
		return;
	}
	
	for(var i=0;i<3;i++)
		sub.push(ftob(deck.first[i]));
	for(var i=0;i<3;i++)
		sub.push(ftob(deck.second[i]));
	for(var i=0;i<3;i++)
		sub.push(ftob(deck.third[i]));
	
	str = "";
	for(var i=0;i<sub.length;i++)
		str += sub[i] + ',';
		
	str = str.substring(0,str.length-1);
	
	var o = ajaxGet('submit?pokerIds='+str+'&giveup=false');
	if(o.status == 'succeed'){
		submittedView();
	}
	handle(o);
})

$(".giveup").click(function(){
	if(comfirm("牌还不错哎，你在看看？确定就真的投降了哎！！！")){
		var o = ajaxGet('giveup');
		if(o.status == 'succeed'){
			submittedView();
			handle(o);
		}else if(o.status == 'failed'){
			alert(o.message);
		}
	}
})

$(".prepare").click(function(){
	var o = ajaxGet("prepare");
	if(o.status === "failed")
		alert(o.message);
	else{
		removePrepare();
		$('body .point,body .three-pokers').remove();
		handle(o);
		$("#gameover").hide();
		$("#gameover table").remove();
		$("#numth").html((localVar.global.number_th+1) + '/' + localVar.global.number_of_games)
	}
})

$(".over").click(function(){
	window.location.href = 'hall';
})

// front card id
function myCard(id,heightSize){
	var index = id%13;
	var color = (id-index)/13;
	index = index + 1;
	var indexStr = index === 1 ? 'A' : index === 11 ? 'J' : index === 12 ? 'Q' : index === 13 ? 'K' : index;
    var colorStr = color === 0 ? 'spades' : color === 1 ? 'hearts' : color === 2 ? 'clubs' : color === 3 ? 'diamonds' : 'joker';

	if(!heightSize){
		var str = '<div class="card '+colorStr+' '+colorStr+''+index+'" style="transition: all 0.01s cubic-bezier(0.215, 0.61, 0.355, 1) 0s;"><div class="topleft">'+indexStr+'</div><div class="bottomright">'+indexStr+'</div><div class="face"></div></div>'
		return $(str);
	}
	if(heightSize > 70){
		var str = '<div class="card '+colorStr+' '+colorStr+''+index+'" style="width:'+(heightSize*0.7)+'px;height:'+heightSize+'px;transition: all 0.01s cubic-bezier(0.215, 0.61, 0.355, 1) 0s;"><div class="topleft">'+indexStr+'</div><div class="bottomright">'+indexStr+'</div><div class="face"></div></div>'
		return $(str);
	}else if(heightSize < 70){
		var str = '<div class="card '+colorStr+' '+colorStr+''+index+'" style="width:'+(heightSize*0.7)+'px;height:'+heightSize+'px;transition: all 0.01s cubic-bezier(0.215, 0.61, 0.355, 1) 0s;"><div class="topleft no-top">'+indexStr+'</div><div class="bottomright no-bottom">'+indexStr+'</div><div class="face"></div></div>'
		return $(str);
	}
}









function ajaxGet(url){
	var data;
	$.ajax({
		url : url,
		type : "get",
		crossDomain:true,
		async:false,
		contentType: "application/json; charset=utf-8",
		success : function(list){
			data = list;
		},
		error:function (XMLHttpRequest, textStatus, errorThrown) {
			alert(XMLHttpRequest.status);
			alert(XMLHttpRequest.readyState);
			alert(textStatus);
		}
	});
	return data;
}

function btof(id){
	
	var color = (id)%4;
	var index = (id-color)/4;
	
	if(index == 12){
		index = 0;
	}else{
		index = index + 1;
	}
	return (3-color)*13 + index;
}

function ftob(id){
	var index = id%13;
	var color = (id - index)/13;
	
	if(index == 0){
		index = 12;
	}else{
		index = index - 1;
	}
	return index*4 + (3-color);
}

function submittedView(){
	$('.sandao .card,.sandao .deck').remove();
	deck.first = [];
	deck.second = [];
	deck.third = [];
	$('#loadingWrapper').hide();
	deck.my_cards = [];
}



/*
deck.addPerson("三毛")
deck.setTotalLeft("三毛",0)
deck.addPerson("咪咪")
deck.setTotalLeft("咪咪",0)
deck.addPerson("黑鱼")
deck.setTotalLeft("黑鱼",0)
deck.addPerson("杨老板")
deck.setTotalLeft("杨老板",0)
deck.addPerson("啊呸")
deck.setTotalLeft("啊呸",0)
deck.intro()
deck.shuffle()
deck.bijiPoker()
deck.bijiPokerOver([1,2,3,4,5,6,7,8,9])
*/

function witchDeckPersonDetail(person_id){
	for(var i=0;i<deck.people_detail.length;i++){
		if(deck.people_detail[i].person_id === person_id){
			return deck.people_detail[i];
		}
	}
}

// 获得显示比分顺序的数组
function getSortBifenDetail(list){
	var A = [];
	for(var i=0;i<3;i++){
		getSortBifenDetailHelper(list,i);
		//list.sort(function(a,b){return a.biFenDetail[i]-b.biFenDetail[i]});
		for(var j=0;j<list.length;j++){
			A.push({tpokers: list[j].pukes.tpukes[i],point: list[j].biFenDetail[i].point, person_id: list[j].person_id, note: list[j].biFenDetail[i].note, witchDao: i});
		}
	}
	return A;
}

// 上一个函数用到的中间函数
function getSortBifenDetailHelper(list,i){
	list.sort(function(a,b){return a.biFenDetail[i].point-b.biFenDetail[i].point});
}
















function handleGlobal(global){
	
	var localPeople = localVar.people;
	var people_num = global.people_num;
	var thisMes = global.thisMes;
	var allMes = global.allMes;
	var lastMes = [];
	
	
	if(allMes.length > 0){
		lastMes = allMes[allMes.length-1];
	}
	
	//加载人的头像，处理 localVar.people
	var mid1 = lastMes;
	if(lastMes.length == 0){
		mid1 = thisMes;
	}
	for(var i=0;i<mid1.length;i++){
		if(localVar.people[mid1[i].person_id] === undefined){
			localVar.people[mid1[i].person_id] = 1;
			deck.addPerson(mid1[i].person_id);
		}
		deck.setTotalLeft(mid1[i].person_id,mid1[i].total_left);
	}
	
	// 第1局
	if(lastMes.length == 0){
		// 显示人的准备信息
		if(thisMes.length < people_num){
			//这里，thisMes.length < people_num 表明在不是所有人都准备的阶段
				// 这里要判断自己在不在thisMes里面，但第一局是没必要的
			handlePrepare(thisMes);
		}else{
			//这里，thisMes.length == people_num 表明发牌阶段了，大家都准备好了
				//分情况：	1、我提交了那么就直接显示都有哪些人提交完成的动画
				//			2、我没提交，那就显示发牌动画（发完牌显示配三道的界面）
			var mid22 = false;
			for(var i=0;i<thisMes.length;i++){
				if(thisMes[i].person_id === localVar.mySelf && thisMes[i].pukes != null){
					mid22 = true;
					break;
				}
			}
			if(mid22){
				//如果我是已经提交的那个人，那就不用发牌阶段了。
				deck.bijiSubmit(getSubmittedPeopleIndex(thisMes));
			}else{
				//如果我没有提交，那就发牌，再显示都有谁提交了
				dealCards(thisMes);
				deck.shuffle();
				deck.bijiSubmit(getSubmittedPeopleIndex(thisMes));
			}
		}
		
	}
	
	// 第K局 某人重新链接的处理
	if(lastMes.length > 0){
		
		if(thisMes.length == 0){
			// 这里所有人都提交完毕，显示比牌动画，最后显示比分
			biFen(lastMes);
			return;
		}
		
		// true 表明未发牌阶段 重新链接
			// 1、如果我在thisMes 里面的话
			// 2、如果我不在thisMes里面的话
		
		// true 表明已发牌阶段 重新链接（thisMes.length == people_num,因此myself 是 必在thisMes里面的）
			// 1、如果我点击提交按钮
			// 2、如果我没有点击提交按钮
			
		var mid2 = thisMes.length < people_num;
		
		if(mid2){
			// true 表明在比完分的准备阶段，
				// 1、如果我也准备了，那么就直接显示准备
				// 2、如果我没有准备，那就显示比分，比完分大家再点击准备
			var mid21 = false;
			for(var i=0;i<thisMes.length;i++){
				if(thisMes[i].person_id === localVar.mySelf){
					mid21 = true;
					break;
				}
			}
			if(mid21){
			// 1、如果我在thisMes 里面的话表明我已经准备好了
				// 刚开局的处理方式一样
				handlePrepare(thisMes);
			}else{
			// 2、如果我不在thisMes里面的话表明要显示比分动画，然后再显示谁准备好了
				// 显示比牌动画，最后显示比分
				if(!document.getElementById("bifen-table")){
					biFen(lastMes);
				}
				handlePrepare(thisMes);
			}
		}
		if(thisMes.length === people_num){
			// 发牌，看牌；提交
			var mid22 = false;
			for(var i=0;i<thisMes.length;i++){
				if(thisMes[i].person_id === localVar.mySelf && thisMes[i].pukes != null){
					mid22 = true;
					break;
				}
			}
			if(mid22){
			// 1、如果我点击提交按钮
				// 显示所有人的准备信息即可
				
				deck.bijiSubmit(getSubmittedPeopleIndex(thisMes));
			}else{
			// 2、如果我没有点击提交按钮
				// 显示所有人的准备信息，显示发牌动画
				dealCards(thisMes);
				deck.shuffle();
				deck.bijiSubmit(getSubmittedPeopleIndex(thisMes));
			}
		}
	}
	
	/*
	
		// 已经全部提交，比分已经出来了
	if(thisMes.length ==0 && allMes.length > 0){

	}
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	

	
	
	str = '';
	for(var i=0;i<thisMes.length;i++){
		
		// 处理人的头像状态
		
		var person_id = thisMes[i].person_id;
		var mes_status = 1;
		if(thisMes[i].pukes != null){
			mes_status = 2;
		}
		
		if(localPeople[person_id] === undefined){
			localPeople[person_id] = mes_status;
			
			deck.addPerson(person_id);
			deck.setTotalLeft(person_id,thisMes[i].total_left);
			
			// 新加一个div{#person_id} 显示头像
		}else if(localPeople[person_id] === 0){
			localPeople[person_id] = mes_status;
			
			// 提示此人重新链接
		}else if(localPeople[person_id] === 1){
			
			localPeople[person_id] = mes_status;
			
		}else if(localPeople[person_id] === 2){
			
			localPeople[person_id] = mes_status;
			// 这个提交状态取消
		}
		
		
		str += '房间号：' + global.room_id + '</br>';
		str += person_id + ' 状态：' + localPeople[person_id] + '（0---离线    1---在线    2---已经submit） </br>';
		
		// 处理扑克牌
		
		var orderedPukes = thisMes[i].orderedPukes;
		var pukes = thisMes[i].pukes;
		
		if(pukes != null){
			// 显示 NinePukes (关闭的九宫格)
			
			str += person_id + '已经提交;</br>';
			
		}else if(orderedPukes.length != 0){
			// 显示连续的9张牌
			// 大家都点击准备，你需要有poker洗牌、发牌的动作，然后九张牌选择比较，提交
			if(thisMes[i].person_id === localVar.mySelf){
				if($("#loadingWrapper").css("display") == "" || $("#loadingWrapper").css("display") == "none"){
					var B = [];
					for(var b=0;b<orderedPukes.length;b++){
						B.push(btof(orderedPukes[b].id));
					}
					deck.bijiPoker();
					deck.bijiPokerOver(B);
				}
			}
			for(var k=0;k<orderedPukes.length;k++)
				str += pokeStr[orderedPukes[k].index] + colors[orderedPukes[k].color];
			
			str += '</br>';
			
		}else{
			// 准备状态
			str += person_id + '已经准备就绪;</br>';
		}
	}
	
	return str;
	*/
}











function biFen(lastMes){
	removeSubmit();
	var biFenDetails = lastMes[0].biFenDetail;
	var xiPaiFenDetails = lastMes[0].xiPaiFenDetail;
	var str = '<table id="bifen-table">';
	str = str + '<tr><th></th><th>牌型</th><th colspan="'+biFenDetails.length+'">比分</th><th colspan="'+(xiPaiFenDetails.length==0?1:xiPaiFenDetails.length)+'">喜牌</th><th>小计</th><th>总计</th></tr>';
	for(var i=0;i<lastMes.length;i++){
		
		var person_id = lastMes[i].person_id;
		var ninepokers = lastMes[i].pukes;
		var biFenDetails = lastMes[i].biFenDetail;
		var xiPaiFenDetails = lastMes[i].xiPaiFenDetail;
		var total = lastMes[i].total;
		var total_left = lastMes[i].total_left;
		
		// person_id / ninepokers / biFenDetails / xiPaiFenDetails / total / total_left
		str += '<tr>';
		
		// person_id
		str += '<td>' + person_id + (ninepokers.giveup?'（弃牌）':'') +'</td>';
		
		// ninepokers
		str += '<td>';
		if(ninepokers.giveup){
			str += '弃牌';
		}else{
			for(var j=0;j<ninepokers.tpukes.length;j++){
				for(var k=0;k<ninepokers.tpukes[0].pukes.length;k++)
					str += pokeStr[ninepokers.tpukes[j].pukes[k].index] + colors[ninepokers.tpukes[j].pukes[k].color] + (k!==2?',':'');
				str += ';'
			}
		}
		str += '</td>';
		
		// biFenDetails
		for(var j=0;j<biFenDetails.length;j++){
			str += '<td>' + biFenDetails[j].point + '</td>';
		}
		// xiPaiFenDetails
		
		if(xiPaiFenDetails.length == 0){
			str += '<td>0</td>';
		}
		for(var j=0;j<xiPaiFenDetails.length;j++){
			str += '<td>' + xiPaiFenDetails[j].point + (xiPaiFenDetails[j].point>0?('（' + xiPaiFenDetails[j].note + '）'):'')+'</td>';
		}
		
		str += '<td>' + total + '</td>';
		str += '<td>' + total_left + '</td>';
		
		str += '</tr>';
	}
	str += '</table>';
	// 将这个表格输出出去
	
	var biFenViewSort = getSortBifenDetail(lastMes);
	
	for(var ii=0;ii<biFenViewSort.length;ii++){
		var tpokers = biFenViewSort[ii].tpokers;
		var witchDao = biFenViewSort[ii].witchDao;
		var this_person_id = biFenViewSort[ii].person_id;
		var point = biFenViewSort[ii].point;
		var note = biFenViewSort[ii].note;
		var tpokersType = tpokers.typeStr;
		var this_person_detail = witchDeckPersonDetail(this_person_id);
		sortViewOrderTpukes(ii,localVar.global.people_num,this_person_detail,tpokers,point)
	}
	setTimeout(function(){
		$("#gameover").show();
		for(var st=0;st<lastMes.length;st++){
			deck.setTotalLeft(lastMes[st].person_id,lastMes[st].total_left);
			if(localVar.global.number_of_games == localVar.global.number_th){
				$('.over').show();
				$('.prepare').hide();
			}
		}
	},1500+500*biFenViewSort.length);
	$("#gameover").append($(str));
	return;
}

// 获得当前这一组中都有哪些人准备好了，并且返回这些人在桌子上的座位顺序
function getSubmittedPeopleIndex(thisMes){
	if(thisMes.length === 0 || thisMes[0].orderedPukes.length === 0) return ;
	//deck.shuffle();
	var A = [];
	for(var i=0;i<thisMes.length;i++){
		if(thisMes[i].pukes!=null){
			A.push(witchDeckPersonDetail(thisMes[i].person_id).index);
		}
	}
	return A;
}

function handleSubmitPerson(this_person_id){
	var this_person_detail = witchDeckPersonDetail(this_person_id);
	$(".cards-"+this_person_detail.index).show(500);
}

function removeSubmit(){
	for(var i=0;i<5;i++)
		$(".cards-"+i).hide(500);
}

function handlePrepare(thisMes){
	if(thisMes.length === 0 || thisMes[0].orderedPukes.length > 0) return ;
	for(var i=0;i<thisMes.length;i++){
		handlePreparePerson(thisMes[i].person_id);
	}
}

function handlePreparePerson(this_person_id){
	var this_person_detail = witchDeckPersonDetail(this_person_id);
	$(".ready-pos-"+this_person_detail.index).show();
}


function removePrepare(){
	$(".ready").hide();
}

function dealCards(thisMes){
	removePrepare();
	for(var i=0;i<thisMes.length;i++){
		if(localVar.mySelf === thisMes[i].person_id && ($("#loadingWrapper").css("display") == "" || $("#loadingWrapper").css("display") == "none")){
			var B = [];
			for(var b=0;b<thisMes[i].orderedPukes.length;b++){
				B.push(btof(thisMes[i].orderedPukes[b].id));
			}
			deck.bijiPoker();
			deck.bijiPokerOver(B);
			break;
		}
	}
}

</script>